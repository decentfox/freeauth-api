WITH
    users := (
        DISTINCT(
            (SELECT User FILTER .name ILIKE <optional str>$q)
            UNION
            (SELECT User FILTER .username ILIKE <optional str>$q)
            UNION
            (SELECT User FILTER .mobile ILIKE <optional str>$q)
            UNION
            (SELECT User FILTER .email ILIKE <optional str>$q)
        )
        IF EXISTS <optional str>$q
        ELSE (SELECT User)
    ),
    name_filter := <optional json>$name,
    users1 := (
        (
            (SELECT users FILTER .name = <str>name_filter['val'])
            IF <str>name_filter['op'] = 'eq'
            ELSE (
                (
                    (SELECT users FILTER .name != <str>name_filter['val'])
                    UNION
                    (SELECT users FILTER NOT EXISTS .name)
                )
                IF <str>name_filter['op'] = 'neq'
                ELSE (
                    (
                        SELECT users
                        FILTER contains(
                            .name,
                            <str>name_filter['val']
                        )
                    )
                    IF <str>name_filter['op'] = 'ct'
                    ELSE (
                        (
                            SELECT users
                            FILTER NOT contains(
                                .name,
                                <str>name_filter['val']
                            )
                        )
                        UNION
                        (SELECT users FILTER NOT EXISTS .name)
                    )
                )
            )
        )
        IF EXISTS <optional json>$name
        ELSE (SELECT users)
    ),
    username_filter := <optional json>$username,
    users2 := (
        (
            (SELECT users1 FILTER .username = <str>username_filter['val'])
            IF <str>username_filter['op'] = 'eq'
            ELSE (
                (
                    (SELECT users1 FILTER .username != <str>username_filter['val'])
                    UNION
                    (SELECT users1 FILTER NOT EXISTS .username)
                )
                IF <str>username_filter['op'] = 'neq'
                ELSE (
                    (
                        SELECT users1
                        FILTER contains(
                            .username,
                            <str>username_filter['val']
                        )
                    )
                    IF <str>username_filter['op'] = 'ct'
                    ELSE (
                        (
                            SELECT users1
                            FILTER NOT contains(
                                .username,
                                <str>username_filter['val']
                            )
                        )
                        UNION
                        (SELECT users1 FILTER NOT EXISTS .username)
                    )
                )
            )
        )
        IF EXISTS <optional json>$username
        ELSE (SELECT users1)
    ),
    mobile_filter := <optional json>$mobile,
    users3 := (
        (
            (SELECT users2 FILTER .mobile = <str>mobile_filter['val'])
            IF <str>mobile_filter['op'] = 'eq'
            ELSE (
                (
                    (SELECT users2 FILTER .mobile != <str>mobile_filter['val'])
                    UNION
                    (SELECT users2 FILTER NOT EXISTS .mobile)
                )
                IF <str>mobile_filter['op'] = 'neq'
                ELSE (
                    (
                        SELECT users2
                        FILTER contains(
                            .mobile,
                            <str>mobile_filter['val']
                        )
                    )
                    IF <str>mobile_filter['op'] = 'ct'
                    ELSE (
                        (
                            SELECT users2
                            FILTER NOT contains(
                                .mobile,
                                <str>mobile_filter['val']
                            )
                        )
                        UNION
                        (SELECT users2 FILTER NOT EXISTS .mobile)
                    )
                )
            )
        )
        IF EXISTS <optional json>$mobile
        ELSE (SELECT users2)
    ),
    email_filter := <optional json>$email,
    users4 := (
        (
            (SELECT users3 FILTER .email = <str>email_filter['val'])
            IF <str>email_filter['op'] = 'eq'
            ELSE (
                (
                    (SELECT users3 FILTER .email != <str>email_filter['val'])
                    UNION
                    (SELECT users3 FILTER NOT EXISTS .email)
                )
                IF <str>email_filter['op'] = 'neq'
                ELSE (
                    (
                        SELECT users3
                        FILTER contains(
                            .email,
                            <str>email_filter['val']
                        )
                    )
                    IF <str>email_filter['op'] = 'ct'
                    ELSE (
                        (
                            SELECT users3
                            FILTER NOT contains(
                                .email,
                                <str>email_filter['val']
                            )
                        )
                        UNION
                        (SELECT users3 FILTER NOT EXISTS .email)
                    )
                )
            )
        )
        IF EXISTS <optional json>$email
        ELSE (SELECT users3)
    ),
    is_deleted_filter := <optional json>$is_deleted,
    users5 := (
        (
            (SELECT users4 FILTER .is_deleted = <bool>is_deleted_filter['val'])
            IF <str>is_deleted_filter['op'] in {'eq', 'ct'}
            ELSE (
                SELECT users4 FILTER .is_deleted != <bool>is_deleted_filter['val']
            )
        )
        IF EXISTS <optional json>$is_deleted
        ELSE (SELECT users4)
    ),
    created_at_filter := <optional json>$created_at,
    users6 := (
        (
            (SELECT users5 FILTER .created_at = <datetime>created_at_filter['val'])
            IF <str>created_at_filter['op'] in {'eq', 'ct'}
            ELSE (
                SELECT users5 FILTER .created_at != <datetime>created_at_filter['val']
            )
        )
        IF EXISTS <optional json>$created_at
        ELSE (SELECT users5)
    ),
    last_login_at_filter := <optional json>$last_login_at,
    users7 := (
        (
            (SELECT users6 FILTER .last_login_at = <datetime>last_login_at_filter['val'])
            IF <str>last_login_at_filter['op'] in {'eq', 'ct'}
            ELSE (
                SELECT users6 FILTER .last_login_at != <datetime>last_login_at_filter['val']
            )
        )
        IF EXISTS <optional json>$last_login_at
        ELSE (SELECT users6)
    ),
    total := count(users7)
select <json>(
    total := total,
    per_page := <int64>$per_page,
    page := <int64>$page,
    last := math::ceil(total / <int64>$per_page),
    rows := array_agg((
        select users7 {
            id,
            name,
            username,
            email,
            mobile,
            is_deleted,
            created_at,
            last_login_at
        }
        offset (<int64>$page - 1) * <int64>$per_page
        limit <int64>$per_page
    ))
);
